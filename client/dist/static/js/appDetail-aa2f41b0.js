import{n as t,v as e,u as a,i as s,a as o,r as i,d as n,g as l,b as r,c as p,e as c,f as d,h as u}from"./index-7b75c17a.js";import{U as h}from"./uploadApp-8ce111bf.js";import{V as f}from"./vue-qr-74b27c98.js";import m from"./appSetting-8b4b99b8.js";import"./vueRouter-5522c294.js";const v={};var g=t({props:{versionInfo:{type:Object},appInfo:{type:Object}},data:()=>({show:!1,updateContent:"",downloadUrl:"",updateType:"normal",isIgnorable:!0,patchEnable:!1,active:!1,grayScaleLimit:!1,grayScaleSize:0,appVersion:"",appVersionDes:"-  `*` 匹配所有版本 \n-  `1.2.3` 匹配特定版本`1.2.3`\n-  `1.2`/`1.2.*` 匹配所有1.2补丁版本 \n-  `>=1.2.3<1.3.7`\n-  `~1.2.3` 匹配`>=1.2.3<1.3.0`\n-  `^1.2.3` 匹配`>=1.2.3<2.0.0`"}),created(){setTimeout((()=>{console.log(this.versionInfo),console.log("this.appInfo",this.appInfo),this.show=!0,this.downloadUrl=this.versionInfo.installUrl,this.versionInfo.changeLog&&(this.updateContent=this.versionInfo.changeLog),this.updateType=this.versionInfo.updateMode,this.isIgnorable=this.versionInfo.isIgnorable,this.patchEnable=this.versionInfo.patchEnable,this.appVersion=this.versionInfo.appVersion,this.active=this.versionInfo.active||!1,this.grayScaleLimit=this.versionInfo.grayScaleLimit||!1,this.grayScaleSize=this.versionInfo.grayScaleSize||0}),200)},methods:{cancel(){this.show=!1,setTimeout((()=>{this.$emit("cancel")}),500)},sure(){let t={changeLog:this.updateContent,active:this.active,updateMode:this.updateType,isIgnorable:this.isIgnorable,patchEnable:this.patchEnable,grayScaleSize:this.grayScaleSize,grayScaleLimit:this.grayScaleLimit};if("rn"==this.appInfo.platform){if(!this.appVersion)return void this.$message.error("请输入版本信息");if(!e(this.appVersion))return void this.$message.error("版本信息格式不正确");t.appVersion=this.appVersion}a(this.appInfo._id,this.versionInfo._id,t).then((t=>{console.log(t),this.$message.success(t.message),this.$emit("updateSuccess")}),(t=>{}))},clickContent(){},getDownLoadCount:t=>t||0,getAllowDownLoadCount:t=>t&&t.downloadCountLimit?t.downloadCountLimit:"不限"}},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"editorVersion-wrapper",on:{click:t.cancel}},[a("transition",{attrs:{name:"fadeRight"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:this.show,expression:"this.show"}],staticClass:"editorVersion-content",on:{click:function(e){return e.stopPropagation(),t.clickContent.apply(null,arguments)}}},[a("div",{staticClass:"top"},[a("i",{staticClass:"icon-ic_editor"}),a("span",[t._v("版本编辑")])]),a("el-form",{attrs:{"label-position":"left",labelWidth:"110px"}},["rn"!=this.appInfo.platform?a("el-form-item",{attrs:{label:"版本信息",required:""}},[a("p",{staticClass:"versionInput"},[t._v(t._s(this.versionInfo.versionName+" (".concat(this.versionInfo.versionCode,")")))])]):t._e(),"rn"==this.appInfo.platform?a("el-form-item",{attrs:{label:"版本信息",required:""}},[a("input",{directives:[{name:"model",rawName:"v-model",value:t.appVersion,expression:"appVersion"}],staticStyle:{width:"72px","border-bottom":"solid 1px #eee","text-align":"center"},attrs:{type:"text"},domProps:{value:t.appVersion},on:{input:function(e){e.target.composing||(t.appVersion=e.target.value)}}}),a("el-tooltip",{staticStyle:{"margin-left":"20px"},attrs:{placement:"right-end"}},[a("div",{attrs:{slot:"content"},slot:"content"},[a("span",{staticStyle:{"white-space":"pre-wrap"}},[t._v(t._s(t.appVersionDes))])]),a("i",{staticClass:"el-icon-warning-outline"})])],1):t._e(),"rn"!==this.appInfo.platform?a("el-form-item",{attrs:{label:"BundleId"}},[a("p",{staticClass:"versionInput"},[t._v(t._s(this.versionInfo.bundleId))])]):t._e(),a("el-form-item",{attrs:{label:"文件大小"}},[a("p",{staticClass:"versionInput"},[t._v(t._s((this.versionInfo.size/1024/1024).toFixed(2))+"M")])]),a("el-form-item",{attrs:{label:"是否发布"}},[a("el-radio",{attrs:{label:!0},model:{value:t.active,callback:function(e){t.active=e},expression:"active"}},[t._v("是")]),a("el-radio",{attrs:{label:!1},model:{value:t.active,callback:function(e){t.active=e},expression:"active"}},[t._v("否")])],1),a("el-form-item",{attrs:{label:"下载次数"}},[a("el-radio",{attrs:{label:!1},model:{value:t.grayScaleLimit,callback:function(e){t.grayScaleLimit=e},expression:"grayScaleLimit"}},[t._v("不限制")]),a("el-radio",{attrs:{label:!0},model:{value:t.grayScaleLimit,callback:function(e){t.grayScaleLimit=e},expression:"grayScaleLimit"}},[t._v("限制")]),a("input",{directives:[{name:"model",rawName:"v-model",value:t.grayScaleSize,expression:"grayScaleSize"}],staticStyle:{width:"72px","border-bottom":"solid 1px #eee","text-align":"center"},attrs:{type:"text"},domProps:{value:t.grayScaleSize},on:{input:function(e){e.target.composing||(t.grayScaleSize=e.target.value)}}}),a("p",{staticStyle:{display:"inline-block",color:"#354052"}},[t._v("次")]),a("p",{staticClass:"versiondownload",staticStyle:{display:"inline-block","margin-left":"10px",color:"#354052"}},[t._v("(已下载"+t._s(this.versionInfo.downloadCount)+"次)")])],1),a("el-form-item",{attrs:{label:"更新方式"}},[a("el-radio",{attrs:{label:"normal"},model:{value:t.updateType,callback:function(e){t.updateType=e},expression:"updateType"}},[t._v("普通更新")]),a("el-radio",{attrs:{label:"silent"},model:{value:t.updateType,callback:function(e){t.updateType=e},expression:"updateType"}},[t._v("静默更新")]),a("el-radio",{attrs:{label:"force"},model:{value:t.updateType,callback:function(e){t.updateType=e},expression:"updateType"}},[t._v("强制更新")])],1),a("el-form-item",{attrs:{label:"是否可忽略"}},[a("el-radio",{attrs:{label:!0},model:{value:t.isIgnorable,callback:function(e){t.isIgnorable=e},expression:"isIgnorable"}},[t._v("是")]),a("el-radio",{attrs:{label:!1},model:{value:t.isIgnorable,callback:function(e){t.isIgnorable=e},expression:"isIgnorable"}},[t._v("否")])],1),"android"==t.appInfo.platform?a("el-form-item",{attrs:{label:"增量更新"}},[a("el-radio",{attrs:{label:!0},model:{value:t.patchEnable,callback:function(e){t.patchEnable=e},expression:"patchEnable"}},[t._v("开启")]),a("el-radio",{attrs:{label:!1},model:{value:t.patchEnable,callback:function(e){t.patchEnable=e},expression:"patchEnable"}},[t._v("关闭")])],1):t._e(),a("el-form-item",{attrs:{label:"更新日志"}},[a("p",{staticClass:"textareacount"},[t._v(t._s(this.updateContent.length)+"/100")]),a("el-input",{staticClass:"editorVersion-updatatextarea",attrs:{type:"textarea",placeholder:"更新日志",maxlength:100},model:{value:t.updateContent,callback:function(e){t.updateContent=e},expression:"updateContent"}})],1)],1),a("el-button",{staticClass:"elbutton-style sureBtn",attrs:{round:""},on:{click:t.sure}},[t._v("确认")]),a("el-button",{staticClass:"elbutton-style cancelBtn",attrs:{round:""},on:{click:t.cancel}},[t._v("取消")])],1)])],1)}),[],!1,b,null,null,null);function b(t){for(let e in v)this[e]=v[e]}var w=function(){return g.exports}();const _={};var I=t({props:{appInfo:{type:Object}},data:()=>({showUploadView:!1,file:FileList,showEditorVersion:!1,versionInfo:{},acceptType:""}),components:{VueQr:f,editorVersion:w,UploadApp:h},watch:{appInfo(t){"ios"==t.platform?this.acceptType=".ipa":"android"==t.platform?this.acceptType=".apk":"rn"==t.platform&&(this.acceptType=".zip"),console.log("acceptType",this.acceptType)}},created(){this.$nextTick((()=>{}))},methods:{getDownLoadUrl(){return window.location.origin+"/"+this.appInfo.shortUrl},clickPreviewBtn(){const{href:t}=this.$router.resolve({name:"AppPreView",path:"/",params:{id:this.appInfo.shortUrl}});window.open(t,"_blank")},getIconUrl(){return this.appInfo.icon?this.appInfo.icon:"ios"==this.appInfo.platform?s:"android"==this.appInfo.platform?o:"rn"==this.appInfo.platform?i:""},getAppType(){return"enterprise"===this.appInfo.appLevel?"企业版":"develop"===this.appInfo.appLevel?"内测版":"appstore"===this.appInfo.appLevel?"AppStore版":""},updateSuccess(){this.showEditorVersion=!1,this.$emit("updateAppInfoSuccess"),this.bus.$emit("uploadSuccess")},cancel(){this.showEditorVersion=!1},referenceUpload(t){this.file=t.target.files,console.log(this.file),t.target.files.length>0&&(this.showUploadView=!0)},deleteApp(t){this.$confirm("确认删除？").then((t=>{n(this.appInfo._id).then((t=>{this.$message.success("删除成功"),this.$router.go(-1)}),(t=>{this.$message.error(t)}))})).catch((t=>{}))},closeUploadMethod(){this.showUploadView=!1,this.$refs.referenceUpload.value=""},uploadSuccessMethod(t){this.showUploadView=!1,this.showEditorVersion=!0,this.$refs.referenceUpload.value="",this.versionInfo=t.data,this.bus.$emit("uploadSuccess"),this.bus.$emit("refreshAppList"),this.bus.$emit("refreshAppInfo")}}},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("div",{staticClass:"detail-header"},[a("div",{staticClass:"detail-header-top"},[a("div",{staticClass:"leftWrapper"},[a("vue-qr",{staticClass:"qrcodeImg",attrs:{autoColor:!1,colorDark:"#354052",text:t.getDownLoadUrl(),margin:20}}),a("div",{staticClass:"title"},[t._v("下载地址")]),a("a",{attrs:{target:"_blank",href:t.getDownLoadUrl()}},[a("span",{staticClass:"url"},[t._v(t._s(this.getDownLoadUrl()))])])],1),a("div",{staticClass:"rightWrapper",staticStyle:{"z-index":"1"}},[a("el-button",{staticClass:"uploadWrapper button-style-main"},[a("i",{staticClass:"icon-ic_upload"}),t._v("上传新版本")]),a("input",{ref:"referenceUpload",staticStyle:{position:"absolute",top:"36px",left:"0px",width:"144px",height:"48px",opacity:"0",cursor:"pointer"},attrs:{title:"上传应用",accept:this.acceptType,type:"file"},on:{change:t.referenceUpload}}),a("button",{staticClass:"preview button-style-border",on:{click:t.clickPreviewBtn}},[t._v("预览")]),a("button",{staticClass:"delete button-style-border",on:{click:t.deleteApp}},[t._v("删除")]),a("div",{staticStyle:{width:"120px",height:"16px","background-color":"#229FFC",position:"absolute",top:"68px",left:"36px","border-radius":"10px",filter:"blur(10px)","z-index":"-1"}})],1)])]),this.showUploadView?a("uploadApp",{attrs:{appInfo:this.appInfo,appFile:this.file},on:{closeUpload:t.closeUploadMethod,uploadSuccess:t.uploadSuccessMethod}}):t._e(),this.showEditorVersion?a("editorVersion",{attrs:{versionInfo:this.versionInfo,appInfo:this.appInfo},on:{cancel:t.cancel,updateSuccess:t.updateSuccess}}):t._e()],1)}),[],!1,y,null,null,null);function y(t){for(let e in _)this[e]=_[e]}var S=function(){return I.exports}();const C={};var A=t({props:{appInfo:{type:Object},subTitleArr:{type:Array}},components:{EditorVersion:w,VueQr:f},data:()=>({headerOperationData:["Bundle ID","下载地址","App Key"],dataArr:[],showEditorVersion:!1,versionInfo:{}}),computed:{},created(){this.$nextTick((()=>{this.getAppVersionListData()})),this.bus.$on("uploadSuccess",(()=>{this.getAppVersionListData()}))},destroyed(){this.bus.$off("uploadSuccess")},methods:{getAppVersionListData(){l(this.appInfo._id,this.currentPage).then((t=>{console.log("VersionList",t.data),this.dataArr=t.data}),(t=>{}))},clickDownLoad(t){const e=document.createElement("a");let a=t.downloadUrl;e.setAttribute("href",a),e.click(),fetch(a).then((e=>{let a=e.body.getReader(),s=e.headers.get("Content-Length"),o=0;a.read().then((function e(i){return i.done?(console.log("下载完成"),void r(t._id).then((()=>{}),(t=>{}))):(o+=i.value.length,console.log(`progress: ${o/s*100}%`),a.read().then(e))}))}))},clickEditor(t){this.showEditorVersion=!0,t.appName=this.appInfo.appName,this.versionInfo=t},clickPreview(t){const{href:e}=this.$router.resolve({name:"AppPreView",path:"/",params:{id:this.appInfo.shortUrl}});window.open(e,"_blank")},clickDelete(t){this.$confirm("确认删除？").then((()=>{p(this.appInfo._id,t._id).then((e=>{this.$message.success("删除成功");let a=this.dataArr.indexOf(t);this.dataArr.splice(a,1),console.log(this.dataArr)}),(t=>{this.$message.error(t)}))})).catch((()=>{}))},releaseApp(t){t.versionName||t.appVersion?c(this.appInfo._id,t._id,!0).then((e=>{this.$message.success(e.message),this.appInfo.releaseVersionId=t._id,this.getAppVersionListData()}),(t=>{})):this.clickEditor(t)},getCreatTime:t=>new Date(t).toFormat(),getUpdateMode:t=>"normal"==t?"普通更新":"silent"==t?"静默更新":"强制更新",getAppSize:t=>`${(t/1024/1024).toFixed(2)}M`,getDownLoadCount:t=>t||0,getAllowDownLoadCount:t=>t.grayScaleLimit?`${t.downloadCount}/${t.grayScaleSize}`:`${t.downloadCount}/不限`,cancel(){this.showEditorVersion=!1},updateSuccess(){this.$emit("updateAppInfoSuccess"),this.showEditorVersion=!1,this.getAppVersionListData()},getIconClass:t=>t.active?t.grayScaleLimit&&t.downloadCount>=t.grayScaleSize?"version-table-one-gray":"version-table-one-lighting":"version-table-one-gray",getTodayCount(){return this.appInfo.todayDownloadCount&&new Date(this.appInfo.todayDownloadCount.date).toDateString()===(new Date).toDateString()?`今日下载次数  ${this.appInfo.todayDownloadCount.count}`:"今日下载次数  0"},getVersion:t=>t.versionName?`${t.versionName}(${t.versionCode})`:t.appVersion||"-"}},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"appVersion-wrapper"},[this.dataArr.length>0?a("div",[t._m(0),a("el-table",{staticClass:"version-table",staticStyle:{width:"100%","box-sizing":"border-box"},attrs:{data:t.dataArr,stripe:"",border:!1}},[a("el-table-column",{attrs:{width:"120",type:"expand"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",{staticStyle:{width:"240px"}},[a("div",{staticStyle:{"margin-bottom":"16px"}},[t._v("增量包")]),a("el-table",{attrs:{border:!0,data:e.row.patchList}},[a("el-table-column",{attrs:{align:"center",label:"label",width:"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("p",{domProps:{innerHTML:t._s(e.row.label)}})]}}],null,!0)}),a("el-table-column",{attrs:{align:"center",label:"size",width:"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("p",{domProps:{innerHTML:t._s(t.getAppSize(e.row.size))}})]}}],null,!0)})],1)],1)]}}],null,!1,1416233773)}),a("el-table-column",{staticClass:"version-table-one",attrs:{width:"90",label:"是否激活",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",{class:t.getIconClass(e.row)})]}}],null,!1,2782388939)}),a("el-table-column",{attrs:{width:"200",align:"center",label:"版本"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("el-dropdown",[a("div",[a("span",[t._v(t._s(t.getVersion(e.row)))]),a("i",{staticClass:"el-icon-arrow-down",staticStyle:{color:"#606266","margin-left":"5px"}})]),a("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[a("vue-qr",{attrs:{autoColor:!1,colorDark:"#354052",text:e.row.installUrl,margin:20}})],1)],1)]}}],null,!1,2318266125)}),a("el-table-column",{attrs:{align:"center",label:"更新时间",width:"170"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("p",{domProps:{innerHTML:t._s(t.getCreatTime(e.row.uploadAt))}})]}}],null,!1,320135178)}),a("el-table-column",{attrs:{align:"center",label:"更新方式",width:"170"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",{staticStyle:{color:"#9B9B9B",display:"inline-block"},domProps:{innerHTML:t._s(t.getUpdateMode(e.row.updateMode))}})]}}],null,!1,3294373045)}),a("el-table-column",{attrs:{align:"center",label:"文件大小",width:"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("p",{domProps:{innerHTML:t._s(t.getAppSize(e.row.size))}})]}}],null,!1,3261518697)}),a("el-table-column",{attrs:{align:"center",label:"下载次数",width:"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",{staticStyle:{color:"#9B9B9B",display:"inline-block"},domProps:{innerHTML:t._s(t.getAllowDownLoadCount(e.row))}})]}}],null,!1,3473435125)}),a("el-table-column",{attrs:{prop:"changeLog",label:"更新日志"}}),a("el-table-column",{attrs:{label:"发布人",width:"120px",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("div",[t._v(t._s(s.uploader))])]}}],null,!1,938753351)}),a("el-table-column",{attrs:{label:"操作",width:"200"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("button",{staticClass:"appversion-elButton",on:{click:function(a){return t.releaseApp(e.row)}}},[a("i",{staticClass:"icon-ic_overview"})]),a("button",{staticClass:"appversion-elButton",on:{click:function(a){return t.clickDownLoad(e.row)}}},[a("i",{staticClass:"icon-ic_download"})]),a("button",{staticClass:"appversion-elButton",on:{click:function(a){return t.clickEditor(e.row)}}},[a("i",{staticClass:"icon-ic_edit"})]),a("button",{staticClass:"appversion-elButton",on:{click:function(a){return t.clickDelete(e.row)}}},[a("i",{staticClass:"icon-ic_delete"})])]}}],null,!1,1068177132)})],1)],1):t._e(),a("div",{staticClass:"appVersion-footerWrapper"},[a("div",{staticClass:"totalWrapper"},[t._m(1),a("p",[t._v("总下载次数 "+t._s(this.appInfo.totalDownloadCount||0))]),a("div",{staticClass:"downloadCount"})]),a("div",{staticClass:"todayWrapper"},[t._m(2),a("p",{domProps:{innerHTML:t._s(t.getTodayCount())}}),a("div",{staticClass:"downloadCount"})])]),this.showEditorVersion?a("editorVersion",{attrs:{versionInfo:this.versionInfo,appInfo:this.appInfo},on:{cancel:t.cancel,updateSuccess:t.updateSuccess}}):t._e()],1)}),[function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"header-content-top"},[a("div",{staticClass:"top-left"},[a("span",{staticClass:"el-icon-tickets",staticStyle:{"margin-right":"6px"}}),t._v("版本信息 ")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"downloadWrapper"},[e("i",{staticClass:"icon-ic_download_s"})])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"downloadWrapper"},[e("i",{staticClass:"icon-ic_download_s"})])}],!1,x,null,null,null);function x(t){for(let e in C)this[e]=C[e]}const k={};var V=t({data:()=>({subTitleArr:["","",""],appInfo:{},showAppSetting:!1,curApp:d.getCurApp()}),components:{AppDetailHeader:S,AppVersions:function(){return A.exports}(),AppSetting:m},computed:{},destroyed(){this.bus.$off("appSummary"),this.bus.$off("appSetting")},created(){this.$nextTick((()=>{this.getAppDetailData()})),this.bus.$on("appSummary",(()=>{this.showAppSetting=!1})),this.bus.$on("appSetting",(()=>{this.showAppSetting=!0}))},methods:{getAppDetailData(){this.curApp=d.getCurApp(),u(this.curApp._id).then((t=>{console.log(t),this.appInfo=t.data,this.subTitleArr=[],this.subTitleArr.push(this.appInfo.bundleId),this.subTitleArr.push(window.location.origin+"/"+this.appInfo.shortUrl),this.subTitleArr.push(this.appInfo._id),this.bus.$emit("appdetail",t.data.appName)}),(t=>{}))},updateAppInfoSuccess(){this.getAppDetailData()}}},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("appDetailHeader",{directives:[{name:"show",rawName:"v-show",value:this.appInfo._id,expression:"this.appInfo._id"}],attrs:{appInfo:this.appInfo},on:{updateAppInfoSuccess:t.updateAppInfoSuccess}}),t.appInfo._id?a("appVersions",{directives:[{name:"show",rawName:"v-show",value:!t.showAppSetting,expression:"!showAppSetting"}],attrs:{appInfo:t.appInfo,subTitleArr:t.subTitleArr},on:{updateAppInfoSuccess:t.updateAppInfoSuccess}}):t._e(),t.showAppSetting?a("appSetting",{attrs:{appInfo:t.appInfo}}):t._e()],1)}),[],!1,L,null,null,null);function L(t){for(let e in k)this[e]=k[e]}var $=function(){return V.exports}();export{$ as default};
